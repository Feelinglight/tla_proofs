# Описание

Алгоритм надежной записи в страничную, энергозависимую память.

[Реализация](https://github.com/irsural/mxsrclib/blob/9723a5b019e9eb1f2a1a811eb16c241b4149e09c/irsmem.h#L130)

Алгоритм разбивает всю память на кластеры заданного размера.

Кластер состоит из двух полукластеров. Полукластеры в одном кластере дублируют друг друга
и нужны для надежной записи в память. Размер полукластера всегда кратен размеру страницы памяти.

В конце каждого полукластера содержится 4 байта чексуммы. Чексумма используется для проверки
целостности данных в полукластере.

Т. о. при использовании алгоритма mem_cluster, количество данных, которые помещаются в память,
уменьшается более чем в 2 раза и равно **(размер_памяти / 2) - (4 * количество_страниц)**.

При записи данных в память, в первую очередь выполняется запись в первый полукластер. После
записи данных рассчитывается их чексумма, которая записывается в последние 4 байта полукластера.

Сразу после записи в первый полукластер, данные записываются во второй полукластер таким же образом.

При нормальной работе полукластеры полностью равны, чексуммы в них совпадают. В этом случае
данные читаются из первого полукластера.

При непредвиденном прерывании записи кластер может остаться в неконсистентом состоянии.
При последующем чтении такого кластера возможны следующие ситуации:

- в первом полукластере валидная чексумма, во втором невалидная

  Это значит, что данные были записаны, но не успели продублироваться во второй полукластер.
  Для восстановления консистентности данные копируются из первого полукластера во второй

- в первом полукластере невалидная чексумма, во втором валидная

  Это значит, что запись была прервана и нужно откатить кластер к состоянию до неудачной записи.
  Для восстановления консистентности данные копируются из второго полукластера в первый

- обе чексуммы невалидны

  Такая ситуация возможна только при ошибках в самой памяти. В этом случае кластер заполняется
  нулями. Чтение такого кластера возвращает нулевые байты.

Описанные выше сценарии восстановления срабатывают только при чтении. Если кластер не читают, то
он будет оставаться в неконсистентом состоянии.

